<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Bluesky On This Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 12px;
    }

    h1 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }

    .post {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .meta {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 6px;
    }

    .meta a {
      color: inherit;
      text-decoration: none;
    }

    .meta a:hover {
      text-decoration: underline;
    }

    .repost {
      color: #0a7;
      margin-right: 4px;
    }

    .text {
      white-space: pre-wrap;
      margin-bottom: 8px;
    }

    .images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 6px;
    }

    .images img {
      width: 100%;
      border-radius: 6px;
    }

    .date {
      font-size: 0.75rem;
      color: #888;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<h1>Bluesky On This Day</h1>
<div id="posts"></div>
<div id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
const DID = "did:plc:fvtougt4vvulbyu3fsahiysm"; // â†ã‚ãªãŸã®DID
const years = 5;                   // â†ã•ã‹ã®ã¼ã‚‹å¹´æ•°

const today = new Date();
const targetMonth = today.getMonth();
const targetDate = today.getDate();
const currentYear = today.getFullYear();

const postsContainer = document.getElementById("posts");
const status = document.getElementById("status");

function isTargetDay(date) {
  return date.getMonth() === targetMonth && date.getDate() === targetDate;
}

function renderPost(item) {
  const post = item.post || item.reason?.by;
  const record = post.record;
  const created = new Date(record.createdAt);

  const div = document.createElement("div");
  div.className = "post";

  const isRepost = item.reason?.$type === "app.bsky.feed.defs#reasonRepost";

  const meta = document.createElement("div");
  meta.className = "meta";

  const postUrl = `https://bsky.app/profile/${post.author.handle}/post/${post.uri.split("/").pop()}`;

  meta.innerHTML = `
    ${isRepost ? '<span class="repost">ğŸ”</span>' : ''}
    <a href="${postUrl}" target="_blank" rel="noopener">
      ${post.author.displayName || post.author.handle}
      <span style="color:#888">@${post.author.handle}</span>
    </a>
  `;
  div.appendChild(meta);

  if (record.text) {
    const text = document.createElement("div");
    text.className = "text";
    text.textContent = record.text;
    div.appendChild(text);
  }

  const images = record.embed?.images;
  if (images?.length) {
    const wrap = document.createElement("div");
    wrap.className = "images";

    images.forEach(img => {
      const image = document.createElement("img");
      image.src = img.fullsize;
      image.loading = "lazy";
      wrap.appendChild(image);
    });

    div.appendChild(wrap);
  }

  const dateDiv = document.createElement("div");
dateDiv.className = "date";
dateDiv.innerHTML = `
  ${created.toLocaleString()}
  Â· <a href="${postUrl}" target="_blank" rel="noopener">å…ƒãƒã‚¹ãƒˆã‚’è¦‹ã‚‹</a>
`;
div.appendChild(dateDiv);

  postsContainer.appendChild(div);
}

async function loadFeed() {
  let cursor = null;
  let stop = false;

  while (!stop) {
    let url = `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${DID}&limit=100`;
    if (cursor) url += `&cursor=${cursor}`;

    const res = await fetch(url);
    const data = await res.json();
    cursor = data.cursor;

    for (const item of data.feed) {
      const post = item.post || item.reason?.by;
      const created = new Date(post.record.createdAt);
      const year = created.getFullYear();

      // ğŸ”´ å–å¾—æ‰“ã¡åˆ‡ã‚Šæ¡ä»¶
      if (year < currentYear - years) {
        stop = true;
        break;
      }

      // ğŸ”µ ä»Šå¹´åˆ†ã¯é™¤å¤–
      if (year === currentYear) continue;

      // ğŸ”µ ã€Œä»Šæ—¥ã€ã ã‘è¡¨ç¤º
      if (!isTargetDay(created)) continue;

      renderPost(item);
    }

    status.textContent = stop
      ? "èª­ã¿è¾¼ã¿å®Œäº†"
      : "ã•ã‚‰ã«éå»ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";

    if (!cursor) break;
  }
}

loadFeed();
</script>

</body>
</html>
