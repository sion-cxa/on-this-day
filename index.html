<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Bluesky nå¹´å‰ã®ä»Šæ—¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 12px;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .post {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .meta {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 6px;
    }
    .repost {
      color: #0a7;
      margin-right: 4px;
    }
    .text {
      white-space: pre-wrap;
      margin-bottom: 8px;
    }
    .images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 6px;
    }
    .images img {
      width: 100%;
      border-radius: 6px;
    }
    .date {
      font-size: 0.75rem;
      color: #888;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<h1>Blueskyï¼šnå¹´å‰ã®ä»Šæ—¥</h1>
<div id="posts">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
const DID = "did:plc:fvtougt4vvulbyu3fsahiysm"; // â†ã‚ãªãŸã®DID
const years = 3;

const today = new Date();
const month = today.getMonth();
const date = today.getDate();
const minYear = today.getFullYear() - years;

const container = document.getElementById("posts");
let firstRendered = false;

function isSameMonthDay(d) {
  return d.getMonth() === month && d.getDate() === date;
}

function renderPost(item) {
  const post = item.post || item.reason?.by;
  const record = post.record;
  const created = new Date(record.createdAt);

  const div = document.createElement("div");
  div.className = "post";

  const meta = document.createElement("div");
  meta.className = "meta";

  const isRepost = item.reason?.$type === "app.bsky.feed.defs#reasonRepost";
  meta.innerHTML = `
    ${isRepost ? '<span class="repost">ğŸ”</span>' : ''}
    @${post.author.handle}
  `;
  div.appendChild(meta);

  if (record.text) {
    const text = document.createElement("div");
    text.className = "text";
    text.textContent = record.text;
    div.appendChild(text);
  }

  const images = record.embed?.images;
  if (images?.length) {
    const imgWrap = document.createElement("div");
    imgWrap.className = "images";
    images.forEach(img => {
      const image = document.createElement("img");
      image.src = img.fullsize;
      image.loading = "lazy";
      imgWrap.appendChild(image);
    });
    div.appendChild(imgWrap);
  }

  const dateDiv = document.createElement("div");
  dateDiv.className = "date";
  dateDiv.textContent = created.toLocaleString();
  div.appendChild(dateDiv);

  container.appendChild(div);
}

async function fetchAndRender(cursor = null) {
  let url = `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${DID}&limit=100`;
  if (cursor) url += `&cursor=${cursor}`;

  const res = await fetch(url);
  const data = await res.json();

  for (const item of data.feed) {
    const post = item.post || item.reason?.by;
    const created = new Date(post.record.createdAt);

    // ğŸ”´ å¤ã™ããŸã‚‰å–å¾—æ‰“ã¡åˆ‡ã‚Š
    if (created.getFullYear() < minYear) {
      return;
    }

    // ä»Šæ—¥ã¨åŒã˜æœˆæ—¥ã ã‘è¡¨ç¤º
    if (isSameMonthDay(created)) {
      if (!firstRendered) {
        container.innerHTML = "";
        firstRendered = true;
      }
      renderPost(item);
    }
  }

  if (data.cursor) {
    await fetchAndRender(data.cursor);
  }
}

fetchAndRender();
</script>

</body>
</html>
